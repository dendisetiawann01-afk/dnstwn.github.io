

<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snake — Ular Makan Tikus (Fixed + Navbar)</title>
<style>
  :root{
    --navbar-h: 64px;
    --bg:#0f1724;
    --panel:#0b1220;
    --snake:#22c55e;
    --snake-head:#16a34a;
    --food:#f43f5e;
    --text:#e6eef8;
    --muted:#9fb0c8;
    --btn:#1f2937;
  }
  [data-theme="light"]{
    --bg:#f4f7fb;
    --panel:#ffffff;
    --snake:#0f7a56;
    --snake-head:#0b6a45;
    --food:#d6333a;
    --text:#0b1220;
    --muted:#465b6a;
    --btn:#e6eef8;
  }

  .color-swatch.selected {
  border: 2px solid white;      /* garis tebal putih saat dipilih */
  box-shadow: 0 0 8px white;    /* efek cahaya halus */
}


  /* Page base */
  html,body{height:100%;margin:0;padding:0;font-family:Poppins,Inter,system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);}

  /* Navbar fixed di atas supaya tidak memotong layar */
  .navbar {
    position:fixed;
    top:0;
    left:0;
    right:0;
    height:var(--navbar-h);
    background:linear-gradient(90deg,#0b6bd6,#0056b3);
    display:flex;
    align-items:center;
    gap:12px;
    padding:0 16px;
    z-index:9999;
    color:white;
    box-shadow:0 6px 18px rgba(0,0,0,0.35);
  }
  .nav-left{display:flex;align-items:center;gap:12px}
  .nav-back {
    background:rgba(255,255,255,0.08);
    color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;text-decoration:none;
  }
  .nav-title{font-weight:800;font-size:16px}

  /* Container utama: beri padding top agar navbar tidak menutup konten */
  main {
    padding-top: calc(var(--navbar-h) + 12px);
    padding-left: 12px;
    padding-right: 12px;
    padding-bottom: 12px;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    min-height: calc(100vh - var(--navbar-h));
  }

  .wrap{max-width:1080px;width:100%;display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start;}
  @media(max-width:980px){ .wrap{grid-template-columns:1fr; } .right-panel{order:2} }

  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.45);position:relative;overflow:visible;}
  .title{font-size:18px;font-weight:800;margin-bottom:8px;color:var(--text)}

  /* Game area: pastikan tinggi maksimal agar tidak kepotong */
  .game-area{
    background:var(--panel);
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
  }

  /* canvas responsive: gunakan max-height menghitung viewport minus navbar dan paddings */
  #gameCanvas{
    width:100%;
    height:100%;
    display:block;
    border-radius:10px;
    background:linear-gradient(180deg,#071020,#071828);
  }

  /* set container height to preserve square and prevent overflow */
  .canvas-wrap {
    width:100%;
    /* max-height = viewport - navbar - outer paddings - right panel top gap */
    max-height: calc(100vh - var(--navbar-h) - 48px);
    aspect-ratio: 1/1;
    display:block;
  }

  /* Right panel */
  .right-panel{display:flex;flex-direction:column;gap:10px}
  .small{font-size:13px;color:var(--muted)}
  button {background:var(--btn);color:var(--text);border:0;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  .big{padding:10px 12px}
  .control-pad{display:grid;grid-template-columns:repeat(3,58px);gap:8px;justify-content:center}
  .pad-btn{width:58px;height:58px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#0b1220;border:2px solid rgba(255,255,255,0.03);font-size:20px}

  /* overlay */
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,23,0.45), rgba(2,6,23,0.65));backdrop-filter: blur(2px);color:var(--text);flex-direction:column;gap:12px;text-align:center;padding:12px;z-index:20;border-radius:8px}
  .overlay input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);width:180px}
  .leaderboard{max-height:220px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .lb-row{display:flex;justify-content:space-between;padding:6px 8px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:14px}

  .credits{font-size:12px;color:var(--muted)}

  /* small responsive tweaks */
  @media (max-width:420px){
    .nav-title{font-size:14px}
    .canvas-wrap{max-height: calc(100vh - var(--navbar-h) - 24px);}
  }
</style>
</head>
<body data-theme="dark">

  <!-- NAVBAR FIXED -->
  <header class="navbar" role="banner">
    <div class="nav-left">
      <a class="nav-back" href="index.html" aria-label="Kembali ke website">⬅ Kembali</a>
      <div class="nav-title">Snake — Ular Makan Tikus (Enhanced)</div>
    </div>
    <div style="margin-left:auto;" class="small">Play — Save — Share</div>
  </header>

  <main>
    <div class="wrap">
      <!-- Game panel -->
      <section class="panel">
        <div class="title">Game</div>

        <div class="canvas-wrap">
          <div class="game-area" id="gameArea" style="height:100%;width:100%">
            <canvas id="gameCanvas" width="700" height="700" aria-label="Game canvas"></canvas>

            <!-- Tambahkan ini **di dalam div.game-area** sebelum overlay existing -->
            <div id="startOverlay" class="overlay" style="display:flex">
                <div style="font-size:20px;font-weight:800">Selamat Datang!</div>
                <div class="small">Masukkan nama untuk memulai game</div>
                <input id="startPlayerName" placeholder="Nama (max 12)" maxlength="12">
                <button id="startGameBtn" class="big" style="margin-top:8px">Start Game</button>
            </div>

            <!-- overlay (pause / gameover) -->
            <div id="overlay" class="overlay" style="display:none">
              <div id="overlayTitle" style="font-size:20px;font-weight:800"></div>
              <div id="overlaySub" class="small"></div>

              <div id="gameOverForm" style="display:none;flex-direction:column;gap:8px;align-items:center">
                <input id="playerName" placeholder="Masukkan nama (max 12)" maxlength="12">
                <div style="display:flex;gap:8px">
                  <button id="saveScoreBtn">Simpan Skor</button>
                  <button id="restartBtn">Restart</button>
                </div>
                <div class="small">Atau tekan Restart untuk langsung main lagi</div>
              </div>

              <div id="pauseBtns" style="display:none;gap:8px">
                <button id="resumeBtn">Lanjut</button>
                <button id="restartBtn2">Restart</button>
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div>
            <div class="small" id="score">Score: 0</div>
            <div class="small" id="level">Level: 1 — Speed: Normal</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="pauseBtn">Pause</button>
            <button id="newGameBtn" class="big">New Game</button>
          </div>
        </div>

        <div class="controls" style="margin-top:12px">
          <div class="small">Kontrol: Panah / WASD · Tombol untuk Mobile</div>
          <div class="control-pad" id="mobilePad" style="margin-top:8px">
            <div></div>
            <div class="pad-btn" data-dir="up">↑</div>
            <div></div>
            <div class="pad-btn" data-dir="left">←</div>
            <div class="pad-btn" data-dir="down">↓</div>
            <div class="pad-btn" data-dir="right">→</div>
          </div>
        </div>
      </section>

      <!-- Right panel -->
      <aside class="right-panel panel" aria-labelledby="Pengaturan">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="title" style="font-size:16px">Pengaturan & Leaderboard</div>
          <div class="small"><label for="themeSelect">Theme</label></div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <div class="small">Theme</div>
          <select id="themeSelect">
            <option value="dark" selected>Dark</option>
            <option value="light">Light</option>
          </select>

          <div class="small">Grid size</div>
          <select id="gridSize">
            <option value="16">16 x 16 (smooth)</option>
            <option value="20" selected>20 x 20 (balanced)</option>
            <option value="28">28 x 28 (detailed)</option>
          </select>

          <div class="small">Food mode</div>
          <select id="foodMode">
            <option value="single" selected>Single</option>
            <option value="multi">Multi</option>
          </select>

          <div class="small">Difficulty multiplier</div>
          <select id="difficulty">
            <option value="1">Easy</option>
            <option value="1.25" selected>Normal</option>
            <option value="1.6">Hard</option>
            <option value="2">Insane</option>
          </select>

          <div class="small">SFX volume</div>
          <input id="vol" type="range" min="0" max="1" step="0.05" value="0.7" />

          <div style="display:flex;gap:6px;align-items:center">
            <div class="small">Skin color:</div>
            <div class="skin-palette">
              <div class="color-swatch" data-snake="#22c55e" style="background:#22c55e;width:22px;height:22px;border-radius:6px;cursor:pointer"></div>
              <div class="color-swatch" data-snake="#f59e0b" style="background:#f59e0b;width:22px;height:22px;border-radius:6px;cursor:pointer"></div>
              <div class="color-swatch" data-snake="#60a5fa" style="background:#60a5fa;width:22px;height:22px;border-radius:6px;cursor:pointer"></div>
              <div class="color-swatch" data-snake="#a78bfa" style="background:#a78bfa;width:22px;height:22px;border-radius:6px;cursor:pointer"></div>
            </div>
          </div>

          <div style="margin-top:6px">
            <div class="small">Tips</div>
            <ul style="margin:6px 0 0 18px;color:var(--muted)">
              <li>Jangan belok 180° langsung.</li>
              <li>Makan tikus -> skor & speed naik.</li>
              <li>Simpan skor ke leaderboard saat Game Over.</li>
            </ul>
          </div>

          <div class="footer" style="margin-top:8px">
            <button id="copyScoreBtn">Copy Score</button>
            <button id="clearLbBtn">Clear Leaderboard</button>
            <button id="showLbBtn">Tampilkan Leaderboard</button>
          </div>

          <div id="leaderboardPanel" style="display:none;margin-top:8px">
            <div class="small">Leaderboard (Top 10)</div>
            <div class="leaderboard" id="leaderboardList"></div>
          </div>

          <div style="margin-top:auto" class="credits">Built for you — open offline, no external assets</div>
        </div>
      </aside>
    </div>
  </main>

<script>
/* Full working script — all functions complete + fixes for cut-off + navbar back */
const canvas = document.getElementById('gameCanvas');
const overlay = document.getElementById('overlay');
const overlayTitle = document.getElementById('overlayTitle');
const overlaySub = document.getElementById('overlaySub');
const gameOverForm = document.getElementById('gameOverForm');
const pauseBtns = document.getElementById('pauseBtns');
const resumeBtn = document.getElementById('resumeBtn');
const restartBtn = document.getElementById('restartBtn');
const restartBtn2 = document.getElementById('restartBtn2');
const saveScoreBtn = document.getElementById('saveScoreBtn');
const playerNameInput = document.getElementById('playerName');

const scoreEl = document.getElementById('score');
const levelEl = document.getElementById('level');

const gridSelect = document.getElementById('gridSize');
const foodModeSelect = document.getElementById('foodMode');
const difficultySelect = document.getElementById('difficulty');
const volRange = document.getElementById('vol');

const themeSelect = document.getElementById('themeSelect');
const bodyEl = document.body;

const leaderBoardList = document.getElementById('leaderboardList');
const leaderboardPanel = document.getElementById('leaderboardPanel');

const copyScoreBtn = document.getElementById('copyScoreBtn');
const clearLbBtn = document.getElementById('clearLbBtn');
const showLbBtn = document.getElementById('showLbBtn');

const mobilePad = document.getElementById('mobilePad');
const padBtns = document.querySelectorAll('.pad-btn');

let ctx = canvas.getContext('2d');
let dpr = window.devicePixelRatio || 1;

// Setup canvas to fit container square without overflow
function setupCanvas(){
  dpr = window.devicePixelRatio || 1;
  // compute available size from canvas wrapper
  const wrap = canvas.parentElement.getBoundingClientRect();
  // choose min of width and height of wrapper to keep square
  const available = Math.min(wrap.width, wrap.height);
  const size = Math.max(220, Math.floor(available)); // min 220
  canvas.width = size * dpr;
  canvas.height = size * dpr;
  canvas.style.width = size + 'px';
  canvas.style.height = size + 'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
setupCanvas();

// WebAudio simple SFX
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep(freq=440, type='sine', time=0.06, vol=0.3){
  try {
    const g = audioCtx.createGain();
    g.gain.value = vol * parseFloat(volRange.value || 0.7);
    const o = audioCtx.createOscillator();
    o.type = type;
    o.frequency.value = freq;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + time);
  } catch(e){
    // ignore audio errors on some browsers
  }
}
function playEatSfx(){ playBeep(880,'sine',0.05,0.15); setTimeout(()=>playBeep(1200,'sine',0.06,0.12),55); }
function playDieSfx(){ playBeep(120,'sawtooth',0.25,0.6); setTimeout(()=>playBeep(80,'sine',0.28,0.4),120); }

// Game state
let state = {};
function resetToDefaults(){
  state = {
    grid: parseInt(gridSelect.value,10),
    cols: parseInt(gridSelect.value,10),
    rows: parseInt(gridSelect.value,10),
    cellSize: 30,
    snake: [],
    dir: {x:1,y:0},
    nextDir: null,
    food: [],
    score: 0,
    speedBase: 5,
    speedMul: parseFloat(difficultySelect.value) || 1,
    tickInterval: 1000 / (5 * (parseFloat(difficultySelect.value)||1)),
    tickAccum:0,
    lastTime:0,
    running:false,
    paused:false,
    gameOver:false,
    particles: []
  };
}

// Particles
function spawnParticles(x,y,color){
  const count = 16;
  for(let i=0;i<count;i++){
    const angle = Math.random()*Math.PI*2;
    const speed = (Math.random()*1.8)+0.6;
    state.particles.push({
      x, y,
      vx: Math.cos(angle)*speed,
      vy: Math.sin(angle)*speed - 0.6,
      life: 60 + Math.random()*30,
      size: Math.max(2, state.cellSize*0.12*Math.random()),
      color
    });
  }
}

// helpers
function posEqual(a,b){ return a.x===b.x && a.y===b.y; }
function randomPos(){
  return { x: Math.floor(Math.random()*state.cols), y: Math.floor(Math.random()*state.rows) };
}
function spawnFood(){
  state.food = [];
  const mode = foodModeSelect.value;
  const count = (mode === 'multi') ? 2 : 1;
  while(state.food.length < count){
    const f = randomPos();
    if(state.snake.some(s=>posEqual(s,f))) continue;
    if(state.food.some(ff=>posEqual(ff,f))) continue;
    state.food.push(f);
  }
}

// START overlay elements
const startOverlay = document.getElementById('startOverlay');
const startNameInput = document.getElementById('startPlayerName');
const startGameBtn = document.getElementById('startGameBtn');

// Game tidak jalan sebelum start
state.running = false;
overlay.style.display = 'none'; // pastikan overlay gameover/pause tidak muncul

startGameBtn.addEventListener('click', ()=>{
  const name = (startNameInput.value || 'Player').trim().slice(0,12);
  playerNameInput.value = name; // simpan ke input utama
  localStorage.setItem('snake_last_name', name);
  startOverlay.style.display = 'none';
  resetState();
  requestAnimationFrame(gameLoop);
});


// reset + start
function resetState(){
  resetToDefaults();
  state.cellSize = Math.floor(canvas.clientWidth / state.cols);
  const mid = Math.floor(state.cols/2);
  state.snake = [{x:mid,y:mid}];
  state.dir = {x:1,y:0};
  state.nextDir = null;
  spawnFood();
  state.score = 0;
  state.running = true;
  state.paused = false;
  state.gameOver = false;
  state.tickAccum = 0;
  lastSpeedIncreaseTime = performance.now();
  updateInfo();
  hideOverlay();
}

// info update
function updateInfo(){
  scoreEl.textContent = `Score: ${state.score}`;
  const sp = Math.round(state.speedBase * state.speedMul * 10)/10;
  levelEl.textContent = `Level: ${Math.max(1, Math.floor(state.score/30)+1)} — Speed: ${sp}`;
}

// step logic
function step(){
  if(state.gameOver || state.paused) return;
  if(state.nextDir){
    if(!(state.nextDir.x === -state.dir.x && state.nextDir.y === -state.dir.y)){
      state.dir = state.nextDir;
    }
    state.nextDir = null;
  }
  const head = { x: state.snake[0].x + state.dir.x, y: state.snake[0].y + state.dir.y };

  // walls -> game over
  if(head.x < 0 || head.x >= state.cols || head.y < 0 || head.y >= state.rows){
    return lose();
  }
  // self-collision
  if(state.snake.some(p=>posEqual(p,head))) return lose();

  state.snake.unshift(head);

  // eat?
  const fIndex = state.food.findIndex(f => posEqual(f, head));
  if(fIndex !== -1){
    state.score += 10;
    const cx = head.x * state.cellSize + state.cellSize/2;
    const cy = head.y * state.cellSize + state.cellSize/2;
    spawnParticles(cx, cy, getComputedStyle(document.documentElement).getPropertyValue('--food').trim());
    playEatSfx();
    state.food.splice(fIndex,1);
    spawnFoodIfNeeded();
    // increase speed every 30 points
    if(state.score % 30 === 0){
      state.speedBase += 0.6;
      state.tickInterval = 1000 / (state.speedBase * state.speedMul);
    }
  } else {
    state.snake.pop();
  }
  updateInfo();
}

function spawnFoodIfNeeded(){
  const mode = foodModeSelect.value;
  if(mode==='single' && state.food.length===0) spawnFood();
  if(mode==='multi' && state.food.length<2) spawnFood();
}

function lose(){
  state.gameOver = true;
  state.running = false;
  playDieSfx();
  showGameOver();
}

// drawing
function draw(){
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);

  // background
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel').trim();
  ctx.fillRect(0,0,w,h);

  // grid faint
  ctx.strokeStyle = 'rgba(255,255,255,0.02)';
  ctx.lineWidth = 1;
  for(let i=0;i<=state.cols;i++){
    const x = i * state.cellSize;
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
  }
  for(let j=0;j<=state.rows;j++){
    const y = j * state.cellSize;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }

  // food
  state.food.forEach(f=>{
    const cx = f.x * state.cellSize + state.cellSize/2;
    const cy = f.y * state.cellSize + state.cellSize/2;
    const r = state.cellSize * 0.32;
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--food').trim();
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx - r*0.6, cy - r*0.6, r*0.36, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx + r*0.6, cy - r*0.6, r*0.36, 0, Math.PI*2); ctx.fill();
  });

  // snake
  for(let i=state.snake.length-1;i>=0;i--){
    const s = state.snake[i];
    const isHead = i===0;
    const x = s.x * state.cellSize;
    const y = s.y * state.cellSize;
    const pad = Math.max(2, state.cellSize*0.08);
    ctx.fillStyle = isHead ? getComputedStyle(document.documentElement).getPropertyValue('--snake-head').trim() : getComputedStyle(document.documentElement).getPropertyValue('--snake').trim();
    roundRect(ctx, x+pad, y+pad, state.cellSize-pad*2, state.cellSize-pad*2, Math.max(6, state.cellSize*0.16));
    ctx.fill();
    if(isHead){
      ctx.fillStyle = '#071827';
      const ex = x + state.cellSize*0.65;
      const ey = y + state.cellSize*0.35;
      ctx.beginPath(); ctx.arc(ex, ey, Math.max(1, state.cellSize*0.06), 0, Math.PI*2); ctx.fill();
    }
  }

  // particles
  for(let i=state.particles.length-1;i>=0;i--){
    const p = state.particles[i];
    ctx.globalAlpha = Math.max(0, p.life/100);
    ctx.fillStyle = p.color || '#fff';
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.08;
    p.vx *= 0.99;
    p.vy *= 0.99;
    p.life -= 2;
    if(p.life <= 0) state.particles.splice(i,1);
  }
}

// round rect helper
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

// game loop
let lastSpeedIncreaseTime = performance.now();
function gameLoop(ts){
  if(!state.running && !state.gameOver) {
    state.lastTime = ts;
    state.running = true;
  }
  const dt = ts - (state.lastTime || ts);
  if(!state.paused && state.running){
    state.tickAccum += dt;
    if(ts - lastSpeedIncreaseTime > 15000){
      state.speedBase += 0.2;
      state.tickInterval = 1000 / (state.speedBase * state.speedMul);
      lastSpeedIncreaseTime = ts;
    }
    while(state.tickAccum >= state.tickInterval){
      step();
      state.tickAccum -= state.tickInterval;
    }
    draw();
  }
  state.lastTime = ts;
  requestAnimationFrame(gameLoop);
}

// input
window.addEventListener('keydown', (e)=>{
  if(document.activeElement === playerNameInput || document.activeElement === startNameInput) return;
  const key = e.key.toLowerCase();
  if(key==='arrowup' || key==='w'){ state.nextDir = {x:0,y:-1}; e.preventDefault(); }
  if(key==='arrowdown' || key==='s'){ state.nextDir = {x:0,y:1}; e.preventDefault(); }
  if(key==='arrowleft' || key==='a'){ state.nextDir = {x:-1,y:0}; e.preventDefault(); }
  if(key==='arrowright' || key==='d'){ state.nextDir = {x:1,y:0}; e.preventDefault(); }
  if(key==='p') togglePause();
  if(key==='r') restartGame();
});

// mobile pad
padBtns.forEach(btn=>{
  btn.addEventListener('touchstart', (ev)=>{ applyDirName(btn.dataset.dir); ev.preventDefault(); }, {passive:false});
  btn.addEventListener('mousedown', ()=> applyDirName(btn.dataset.dir));
});
function applyDirName(name){
  if(name==='up') state.nextDir = {x:0,y:-1};
  if(name==='down') state.nextDir = {x:0,y:1};
  if(name==='left') state.nextDir = {x:-1,y:0};
  if(name==='right') state.nextDir = {x:1,y:0};
}

// UI buttons
document.getElementById('newGameBtn').addEventListener('click', ()=> restartGame());
document.getElementById('pauseBtn').addEventListener('click', ()=> togglePause());
resumeBtn && resumeBtn.addEventListener('click', ()=> { hideOverlay(); state.paused=false; state.running=true; });
restartBtn && restartBtn.addEventListener('click', ()=> { restartGame(); });
restartBtn2 && restartBtn2.addEventListener('click', ()=> { restartGame(); });
saveScoreBtn && saveScoreBtn.addEventListener('click', saveScoreLocal);
document.getElementById('copyScoreBtn').addEventListener('click', ()=> {
  navigator.clipboard?.writeText(`My snake score: ${state.score}`).then(()=>alert('Score disalin!'), ()=>alert('Tidak bisa menyalin.'));
});
clearLbBtn.addEventListener('click', ()=> {
  if(confirm('Hapus seluruh leaderboard?')) {
    localStorage.removeItem('snake_leaderboard_v1');
    renderLeaderboard();
  }
});
showLbBtn.addEventListener('click', ()=> {
  leaderboardPanel.style.display = leaderboardPanel.style.display === 'none' ? 'block' : 'none';
  renderLeaderboard();
});

// settings
gridSelect.addEventListener('change', ()=> { resetState(); });
foodModeSelect.addEventListener('change', ()=> { resetState(); });
difficultySelect.addEventListener('change', ()=> {
  state.speedMul = parseFloat(difficultySelect.value);
  state.tickInterval = 1000 / (state.speedBase * state.speedMul);
});
volRange.addEventListener('input', ()=> {/* volume applied in playBeep */});

// theme & skin
themeSelect.addEventListener('change', ()=> {
  const t = themeSelect.value;
  bodyEl.setAttribute('data-theme', t);
});

document.querySelectorAll('.color-swatch').forEach(s => {
  s.addEventListener('click', () => {
    const val = s.dataset.snake;
    document.documentElement.style.setProperty('--snake', val);
    const darker = shadeColor(val, -12);
    document.documentElement.style.setProperty('--snake-head', darker);

    // Hapus class 'selected' dari semua swatch
    document.querySelectorAll('.color-swatch').forEach(sw => sw.classList.remove('selected'));

    // Tambahkan class 'selected' ke yang diklik
    s.classList.add('selected');
  });
});


function shadeColor(hex, percent) {
  const f = parseInt(hex.slice(1),16);
  const t = percent < 0 ? 0 : 255;
  const p = Math.abs(percent)/100;
  const R = Math.round((t - (f>>16)) * p) + (f>>16);
  const G = Math.round((t - ((f>>8)&0x00FF)) * p) + ((f>>8)&0x00FF);
  const B = Math.round((t - (f&0x0000FF)) * p) + (f&0x0000FF);
  return `#${(0x1000000 + (R<<16) + (G<<8) + B).toString(16).slice(1)}`;
}

// overlay helpers
function showOverlay(title, sub, mode='pause'){
  overlayTitle.textContent = title;
  overlaySub.textContent = sub || '';
  overlay.style.display = 'flex';
  gameOverForm.style.display = (mode==='gameover') ? 'flex' : 'none';
  pauseBtns.style.display = (mode==='pause') ? 'flex' : 'none';
  if(mode==='gameover') {
    playerNameInput.value = localStorage.getItem('snake_last_name') || '';
  }
}
function hideOverlay(){ overlay.style.display = 'none'; gameOverForm.style.display = 'none'; pauseBtns.style.display='none'; }

function showGameOver(){
  showOverlay('Game Over', `Score: ${state.score}`, 'gameover');
}

function togglePause(){
  state.paused = !state.paused;
  if(state.paused) {
    showOverlay('Paused', 'Tekan Lanjut untuk kembali', 'pause');
  } else {
    hideOverlay();
  }
}

function restartGame(){
  resetState();
  requestAnimationFrame(gameLoop);
}

// leaderboard
function loadLeaderboard(){
  try{
    const raw = localStorage.getItem('snake_leaderboard_v1');
    return raw ? JSON.parse(raw) : [];
  } catch(e){ return []; }
}
function saveLeaderboard(lb){ localStorage.setItem('snake_leaderboard_v1', JSON.stringify(lb)); }
function saveScoreLocal(){
  const name = (playerNameInput.value || 'Player').trim().slice(0,12);
  localStorage.setItem('snake_last_name', name);
  const lb = loadLeaderboard();
  lb.push({name, score: state.score, ts: Date.now()});
  lb.sort((a,b)=>b.score - a.score);
  while(lb.length > 10) lb.pop();
  saveLeaderboard(lb);
  renderLeaderboard();
  hideOverlay();
  restartGame();
}
function renderLeaderboard(){
  const lb = loadLeaderboard();
  leaderBoardList.innerHTML = lb.length ? lb.map((it, idx)=>`<div class="lb-row"><div>${idx+1}. ${escapeHtml(it.name)}</div><div>${it.score}</div></div>`).join('') : '<div class="small">Belum ada skor tersimpan</div>';
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
renderLeaderboard();


// mobile pad visibility & resize handling
function updateMobilePadVisibility(){
  if(window.innerWidth < 780) mobilePad.style.display = 'grid';
  else mobilePad.style.display = 'none';
}
updateMobilePadVisibility();

window.addEventListener('resize', ()=> {
  setupCanvas();
  state.cellSize = Math.floor(canvas.clientWidth / state.cols);
  updateMobilePadVisibility();
});

// unlock audio on gesture
document.addEventListener('pointerdown', function one(){ if(audioCtx.state === 'suspended'){ audioCtx.resume(); } document.removeEventListener('pointerdown', one); }, {once:true});

</script>
</body>
</html>

